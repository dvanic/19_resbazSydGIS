### Raster Calculations

# Initial setup and definitions

In this lesson we will learn how to calculate a third raster object based on two rasters. 

- **DSM:** Digital surface model. This represents the elevation of the highest point (including objects on the surface) on the surface. This means the elevation of the tops of trees and shrubs and other vegetation on the surface, if it exists.

- **DTM:**: Digital Terrain Model. This is just the elevation of the terrain (surface) without the vegetation.

Using these two we will try and calculate the

- **Canopy Height Model:** This is the height of the vegetation corrected for the elevation of the terrain. I.e. **DSM** - **DTM**.



Load rgdal and raster libraries if not already loaded
```{r}

## Challenge 9
# Use GDALinfo() fucntion to view information about the DTM and DSM data files. Do the two rasters have the same or different CRSs and resolutions? DO they both have defined minimum and maximum values?
  
library(rgdal)
library(raster)
```


```{r}
GDALinfo("data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif")
GDALinfo("data/NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_dtmCrop.tif")
```
*Yes they both have the same CRS and res and both have min and max values*

If you haven't already done so, load rasters and convert into data.frames
```{r}
DSM_HARV <- raster("data/NEON-DS-Airborne-Remote-Sensing/HARV/DSM/HARV_dsmCrop.tif")
DTM_HARV <- raster("data/NEON-DS-Airborne-Remote-Sensing/HARV/DTM/HARV_dtmCrop.tif")

# Convert into dfs
DSM_HARV_df <- as.data.frame(DSM_HARV, xy = TRUE)
DTM_HARV_df <- as.data.frame(DTM_HARV, xy = TRUE)
```

Do quick plots to view the raster/dfs

Load ggplot if haven't done so.
```{r}
library(ggplot2)
```

```{r}
# DSM_HARV

# raster plot
plot(DSM_HARV)
# ggplot
ggplot() +
  geom_raster(data = DSM_HARV_df, aes(x = x, y = y, fill = HARV_dsmCrop)) +
  scale_fill_gradientn(name = "Elevation", colours = terrain.colors(10)) +
  coord_quickmap()
```

```{r}
# DTM_HARV
# ggplot
ggplot() +
  geom_raster(data = DTM_HARV_df, aes(x = x, y = y, fill = HARV_dtmCrop)) +
  scale_fill_gradientn(name = "Elevation", colours = terrain.colors(10)) +
  coord_quickmap()
```

# Raster Calculations

- Most of the times we can just use raster math. You can add, sub, divide, mulitple, log, exp etc. rasters directly.
- For more complex calculations or large rasters, we can use the much more efficient overlay function

## Raster Math

We will subtract DTM from DSM
```{r}
CHM_HARV <- DSM_HARV - DTM_HARV

# Convert to df
CHM_HARV_df <- as.data.frame(CHM_HARV, xy = TRUE)
str(CHM_HARV_df)
```

Plot using ggplot
```{r}
ggplot() +
  geom_raster(data = CHM_HARV_df, aes(x = x, y = y, fill = layer)) + 
  scale_fill_gradientn(name = "Canopy Height", colours = terrain.colors(10)) +
  coord_quickmap()
```

Distribution of canopy heights
```{r}
ggplot() +
  geom_histogram(data = CHM_HARV_df, aes(layer))
```

Does the above distribution make sense?

### Challenge 2
It’s often a good idea to explore the range of values in a raster dataset just like we might explore a dataset that we collected in the field.

1. What is the min and maximum value for the Harvard Forest Canopy Height Model (CHM_HARV) that we just created?
2. What are two ways you can check this range of data for CHM_HARV?
3. Plot a histogram with 6 bins instead of the default and change the color of the histogram.
4. Plot the CHM_HARV raster using breaks that make sense for the data. Include an appropriate color palette for the data, plot title and no axes ticks / labels.

```{r}
CHM_HARV
```
1. min: 0 max: 38.17
2. print raster object, use min() and max() functions (don't forget na.rm argument), create histogram
3. 
```{r}
ggplot() + 
  geom_histogram(data = CHM_HARV_df, aes(layer),
                 bins = 6, colour = "black", 
                 fill = "darkgreen")
```
4.
Load dplyr library
```{r}
library(dplyr)
```

```{r}
custom_bins <- c(0, 10, 20, 30, 40)
CHM_HARV_df <- CHM_HARV_df %>% mutate(canopy_discrete = cut(layer, breaks = custom_bins))

# plot
ggplot() +
  geom_raster(data = CHM_HARV_df, aes(x = x, y = y, fill = canopy_discrete)) + 
  scale_fill_manual(name = "Canopy Height (m)", values = terrain.colors(length(custom_bins)-1)) +
  ggtitle("Harvard Forrest Canopy Height") + 
  theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank()) + 
  coord_quickmap()
```

## Raster calculations Overlay function

We use the overlay function when:

1. calculation are complex.
2. rasters are large! thus slowing computation times.
3. rasters are stored as individual files. Often because they are too large to read in a store in memory.

**Note:** If using RasterStacks or RasterBricks, use calc() instead of overlay().

```{r}
CHM_ov_HARV <- overlay(DSM_HARV,
                       DTM_HARV,
                       fun = function(r1, r2) {
                         return(r1 - r2)
                       })
```

Convert to df for plotting
```{r}
CHM_ov_HARV_df <- as.data.frame(CHM_ov_HARV, xy = TRUE)
str(CHM_ov_HARV_df)
```

Now the plot
```{r}
ggplot() +
  geom_raster(data = CHM_ov_HARV_df, aes(x = x, y = y, fill = layer)) + 
  scale_fill_gradientn(name = "Canopy Height", colours = terrain.colors(10)) +
  coord_quickmap()
```

Compare the two plots from the two different raster calculation methods. They should be identical.

## Export rasters as GeoTIFFs

Done using writeRaster() function. 

Specify format with format argument (GTiff for us), overwrite argument tells R to overwrite if file exists, and no data values can be specified with NAflag argument (-9999). -9999 is the National Ecology Observation Network's (NEON) standard NoDataValue.
```{r}
writeRaster(CHM_ov_HARV,
            "data/NEON-DS-Airborne-Remote-Sensing/HARV/CHM/CHM_HARV.tiff",
            format = "GTiff",
            overwrite = TRUE,
            NAflag = -9999)
```

### Challenge 3
Data are often more interesting and powerful when we compare them across various locations. Let’s compare some data collected over Harvard Forest to data collected in Southern California. The NEON San Joaquin Experimental Range (SJER) field site located in Southern California has a very different ecosystem and climate than the NEON Harvard Forest Field Site in Massachusetts.

Import the SJER DSM and DTM raster files and create a Canopy Height Model. Then compare the two sites. Be sure to name your R objects and outputs carefully, as follows: objectType_SJER (e.g. DSM_SJER). This will help you keep track of data from different sites!

1. You should have the DSM and DTM data for the SJER site already loaded from the Plot Raster Data in R episode.) Don’t forget to check the CRSs and units of the data.
```{r}
DSM_SJER <- raster("data/NEON-DS-Airborne-Remote-Sensing/SJER/DSM/SJER_dsmCrop.tif")
DTM_SJER <- raster("data/NEON-DS-Airborne-Remote-Sensing/SJER/DTM/SJER_dtmCrop.tif")

DSM_SJER
DTM_SJER
```
*Res, CRS and units are the same*

2. Create a CHM from the two raster layers and check to make sure the data are what you expect.
```{r}
CHM_SJER <- DSM_SJER - DTM_SJER

CHM_SJER
```
Using the overlay function:
```{r}
CHM_ov_SJER <- overlay(DSM_SJER,
                       DTM_SJER,
                       fun = function(r1, r2) {
                         return(r1 - r2)
                       })

CHM_ov_SJER
```
*In both cases the min is negative!*

3. Plot the CHM from SJER.
```{r}
# Conver to df
CHM_ov_SJER_df <- as.data.frame(CHM_ov_SJER, xy = TRUE)

ggplot() +
  geom_raster(data = CHM_ov_SJER_df, aes(x = x, y = y, fill = layer)) + 
  scale_fill_gradientn(name = "Canopy Height", colours = terrain.colors(10)) +
  coord_quickmap()
```

4. Export the SJER CHM as a GeoTIFF.
```{r}
system("mkdir data/NEON-DS-Airborne-Remote-Sensing/SJER/CHM")

writeRaster(CHM_ov_SJER,
            "data/NEON-DS-Airborne-Remote-Sensing/SJER/CHM/CHM_SJER.tiff",
            format = "GTiff",
            overwrite = TRUE,
            NAflag = -9999)
```

5. Compare the vegetation structure of the Harvard Forest and San Joaquin Experimental Range.
```{r}
# we can compare by plotting histograms
# Harvard forrest
ggplot() +
  geom_histogram(data = CHM_HARV_df, aes(layer))
# San Joaquin Env res.
ggplot() +
  geom_histogram(data = CHM_ov_SJER_df, aes(layer))
```
*SJER is a lot more barren and had much shorter vegetation.*
